<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sweet Points Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: "Comic Sans MS", "Chalkboard SE", "Comic Neue", cursive;
      background: #fdf6e3;
      color: #333;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
      font-size: 2em;
    }

    .category {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff3cd;
      border: 2px solid #ffeeba;
      border-radius: 12px;
      padding: 10px 20px;
      margin: 10px 0;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
    }

    .category span {
      font-size: 1.3em;
    }

    .buttons {
      display: flex;
      gap: 10px;
    }

    .buttons button {
      font-size: 1.2em;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .add { background-color: #d4edda; }
    .subtract { background-color: #f8d7da; }

    .total {
      text-align: center;
      font-size: 1.5em;
      margin-top: 20px;
      background-color: #cce5ff;
      border: 2px solid #b8daff;
      border-radius: 12px;
      padding: 15px;
    }

    button, input, select, textarea {
        font-size: 16px; /* Prevent iOS zoom on tap */
    }

    #progressBar {
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        margin-top: 20px;
        font-size: 1.3em;
        display: flex;
        height: 30px;
        border: 2px solid #ccc;
        border-radius: 10px;
    }

    .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(to right, #FFD700, #FF69B4, #87CEEB, #98FB98);
        display: flex;
        align-items: center;
        transition: width 0.5s ease;
    }

    .progress-segment {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #000;
        height: 100%;
    }

    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-15px);
        }
        60% {
            transform: translateY(-8px);
        }
    }

    .bounce {
        animation: bounce 1s ease infinite;
    }
  </style>
</head>

<body>

    <h1>üç¶ My Sweet Points Tracker üç∞ </h1>
    
    <label for="selectedDate">Select Date:</label>
    <input type="date" id="selectedDate" />

    <div id="categories"></div>

    <div id="progressWrapper" style="margin-top: 20px;">
        <div style="font-weight: bold; text-align: center;">üìä Total Progress: <span id="progressPercent">0%</span></div>
        <div id="progressBar"></div>
        <div id="progressMessage" style="text-align:center; font-size: 1.5em; margin-top: 10px; color: #4CAF50;"></div>
    </div>

    <button onclick="saveAndUpdate()" style="margin-top: 10px; padding: 10px; font-size: 1em;">
    üíæ Save Today's Progress
    </button>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCt96hZOKqr3i2WUiOt377wUAxn7dvS2AI",
            authDomain: "sweetpoints-9d554.firebaseapp.com",
            projectId: "sweetpoints-9d554",
            storageBucket: "sweetpoints-9d554.firebasestorage.app",
            messagingSenderId: "1004205005159",
            appId: "1:1004205005159:web:22396a31eee947b09af7c2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>

    <script>

        const defaultCategories = [
            { name: "üòä Kindness", key: "kindness", color: "#FFD700" },        // Gold - warm and joyful
            { name: "üî¢ Math Study", key: "math_study", color: "#87CEEB" },    // Sky Blue - clarity and focus
            { name: "üÄÑ Chinese Study", key: "chinese_study", color: "#DA70D6" }, // Orchid - thoughtful and creative
            { name: "üéπ Piano Practice", key: "piano_practice", color: "#FFA07A" }, // Light Salmon - artistic energy
            { name: "üí™ Helping", key: "helping", color: "#98FB98" }           // Pale Green - kindness and support
        ];

        const categoriesDiv = document.getElementById("categories");
        const progressPercent = document.getElementById("progressPercent");
        const progressBar = document.getElementById("progressBar");
        const progressMessage = document.getElementById("progressMessage");
        let points = getEmptyPoints();
        let log = [];
        
        const TOTAL_GOAL = 50;
        let cumulativeStart = 0;

        let currentDate = new Date().toLocaleDateString("en-CA"); // YYYY-MM-DD
        document.getElementById("selectedDate").value = currentDate;
        document.getElementById("selectedDate").addEventListener("change", (e) => {
            currentDate = e.target.value;
            loadProgressFromFirebase(currentDate, (data) => {
                points = data.points || getEmptyPoints();
                log = data.log || [];
                cumulativeStart = data.cumulativeStart || 0;
                updateDisplay();
            });
        });

        function getEmptyPoints() {
            return {
                kindness: 0,
                math_study: 0,
                chinese_study: 0,
                piano_practice: 0,
                helping: 0
            };
        }

        function isTodaySelected() {
            // Allow edits only on today
            const today = new Date().toLocaleDateString("en-CA");
            //return currentDate === today;
            return 1;
        }

        function updateDisplay() {
            categoriesDiv.innerHTML = "";

            let totalToday = 0;

            defaultCategories.forEach(({ name, key }) => {
                const categoryDiv = document.createElement("div");
                categoryDiv.className = "category";

                const label = document.createElement("span");
                label.textContent = `${name}: ${points[key]} pts`;

                const btnAdd = document.createElement("button");
                btnAdd.disabled = !isTodaySelected();
                btnAdd.textContent = "+";
                btnAdd.className = "add";
                btnAdd.onclick = () => {
                    if (!isTodaySelected()) return;
                    points[key]++;
                    logPointChange(key, 1);
                    saveAndUpdate();
                };

                const btnSub = document.createElement("button");
                btnSub.textContent = "‚àí";
                btnSub.className = "subtract";
                btnSub.disabled = !isTodaySelected();
                btnSub.onclick = () => {
                    if (!isTodaySelected()) return;
                    if (points[key] > 0) {
                        points[key]--;
                        logPointChange(key, -1);
                        saveAndUpdate();
                    }
                };

                const btns = document.createElement("div");
                btns.className = "buttons";
                btns.appendChild(btnAdd);
                btns.appendChild(btnSub);

                categoryDiv.appendChild(label);
                categoryDiv.appendChild(btns);
                categoriesDiv.appendChild(categoryDiv);

                totalToday += points[key];
            });

            drawProgressBar(totalToday);
        }

        function saveAndUpdate() {
            const totalToday = Object.values(points).reduce((a, b) => a + b, 0);
            const cumulativeTotal = cumulativeStart + totalToday;

            updateDisplay();

            db.ref(`progressLog/${currentDate}`).set({ points, log, cumulativeTotal, cumulativeStart })
            .then(() => console.log("Synced to Firebase"))
            .catch(error => console.error("Sync failed:", error));
        }

        function logPointChange(category, delta) {
            const now = new Date();
            const local_ts = `${now.toLocaleDateString("en-CA")} ${now.toLocaleTimeString("en-US")}`;
            log.push({
                category,
                delta,
                local_ts,
            });
        }

        function drawProgressBar(totalToday) {
            progressBar.innerHTML = "";

            // Show segments by category proportional to total goal (50)
            defaultCategories.forEach(({ name, key, color }) => {
                const value = points[key];
                if (value > 0) {
                    let widthPercent = (value / TOTAL_GOAL) * 100;
                    if (value >= 1 && widthPercent < 4) widthPercent = 4;

                    const segment = document.createElement("div");
                    segment.className = "progress-segment";
                    segment.style.width = `${widthPercent}%`;
                    segment.style.backgroundColor = color;
                    segment.textContent = name.match(/[\p{Emoji}\u2600-\u27BF]/u)?.[0] || "";
                    progressBar.appendChild(segment);
                }
            });

            const grandTotal = cumulativeStart + totalToday;
            const percent = Math.min((grandTotal / TOTAL_GOAL) * 100, 100);
            progressPercent.textContent = `${Math.round(percent)}%`;

            if (grandTotal >= TOTAL_GOAL) {
                progressMessage.textContent = "üåü Amazing Job! You reached your goal! üèÜ";
                progressMessage.classList.add("bounce");
            } else {
                progressMessage.classList.remove("bounce");
                progressMessage.textContent = `You have ${grandTotal} points, only ${TOTAL_GOAL - grandTotal} to go! üöÄ`;
            }
        }

        function getPreviousDate(dateStr) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() - 1);
            return date.toLocaleDateString("en-CA");
        }

        function loadProgressFromFirebase(date, callback) {
            const prevDate = getPreviousDate(date);

            Promise.all([
                db.ref(`progressLog/${date}`).once('value'),
                db.ref(`progressLog/${prevDate}`).once('value')
            ]).then(([todaySnap, prevSnap]) => {
                const todayData = todaySnap.val();
                const prevData = prevSnap.val();

                const prevCumulative = prevData?.cumulativeTotal || 0;
                const points = todayData?.points || getEmptyPoints();
                const log = todayData?.log || [];
                // Start cumulative from yesterday's total
                const cumulativeStart = prevCumulative;

                callback({ points, log, cumulativeStart });
            }).catch(error => {
                console.error("Load failed:", error);
                callback({ points: getEmptyPoints(), log: [], cumulativeStart: 0 });
            });
        }

        async function loadInitialProgress(date) {
            const prevDate = getPreviousDate(date);
            try {
                const prevSnap = await db.ref(`progressLog/${prevDate}`).once('value');
                const prevData = prevSnap.val();
                const prevCumulative = prevData?.cumulativeTotal || 0;

                const todaySnap = await db.ref(`progressLog/${date}`).once('value');
                const todayData = todaySnap.val();

                points = todayData?.points || getEmptyPoints();
                log = todayData?.log || [];
                cumulativeStart = prevCumulative;

                updateDisplay();
            } catch (error) {
                console.error("Load failed:", error);
                points = getEmptyPoints();
                log = [];
                cumulativeStart = 0;
                updateDisplay();
            }
        }

        // Use this to load on initial page load:
        loadInitialProgress(currentDate);

    </script>
</body>
</html>
