<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sweet Points Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: "Comic Sans MS", "Chalkboard SE", "Comic Neue", cursive;
      background: #fdf6e3;
      color: #333;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
      font-size: 2em;
    }

    .category {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff3cd;
      border: 2px solid #ffeeba;
      border-radius: 12px;
      padding: 10px 20px;
      margin: 10px 0;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
    }

    .category span {
      font-size: 1.3em;
    }

    .buttons {
      display: flex;
      gap: 10px;
    }

    .buttons button {
      font-size: 1.2em;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .add { background-color: #d4edda; }
    .subtract { background-color: #f8d7da; }

    .total {
      text-align: center;
      font-size: 1.5em;
      margin-top: 20px;
      background-color: #cce5ff;
      border: 2px solid #b8daff;
      border-radius: 12px;
      padding: 15px;
    }

    button, input, select, textarea {
        font-size: 16px; /* Prevent iOS zoom on tap */
    }
    
  </style>
</head>

<body>

    <h1>üç¶ My Sweet Points Tracker üç∞ </h1>
    
    <label for="selectedDate">Select Date:</label>
    <input type="date" id="selectedDate" />

    <div id="categories"></div>

    <div class="total">
        üßÆ Total Points: <span id="totalPoints">0</span>
    </div>

    <h2>üìÖ Progress by Day</h2>
    <canvas id="progressChart" width="400" height="200"></canvas>
    <button onclick="saveChartAndLog()" style="margin-top: 10px; padding: 10px; font-size: 1em;">
    üíæ Save Progress
    </button>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>


    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCt96hZOKqr3i2WUiOt377wUAxn7dvS2AI",
            authDomain: "sweetpoints-9d554.firebaseapp.com",
            projectId: "sweetpoints-9d554",
            storageBucket: "sweetpoints-9d554.firebasestorage.app",
            messagingSenderId: "1004205005159",
            appId: "1:1004205005159:web:22396a31eee947b09af7c2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>

    <script>

        const defaultCategories = [
            { name: "üòä Kindness", key: "kindness", color: "#FFD700" },        // Gold - warm and joyful
            { name: "üî¢ Math Study", key: "math_study", color: "#87CEEB" },    // Sky Blue - clarity and focus
            { name: "üÄÑ Chinese Study", key: "chinese_study", color: "#DA70D6" }, // Orchid - thoughtful and creative
            { name: "üéπ Piano Practice", key: "piano_practice", color: "#FFA07A" }, // Light Salmon - artistic energy
            { name: "üí™ Helping", key: "helping", color: "#98FB98" }           // Pale Green - kindness and support
        ];

        const categoriesDiv = document.getElementById("categories");
        const totalPointsSpan = document.getElementById("totalPoints");
        const progressLogDiv = document.getElementById("progressLog");
        let chart = null;
        let points = getEmptyPoints();
        let log = [];

        let currentDate = new Date().toLocaleDateString("en-CA"); // YYYY-MM-DD
        document.getElementById("selectedDate").value = currentDate;
        document.getElementById("selectedDate").addEventListener("change", (e) => {
            currentDate = e.target.value;
            loadProgressFromFirebase(currentDate, (data) => {
                points = data.points || getEmptyPoints();
                log = data.log || [];
                updateDisplay();
            });
        });

        function getEmptyPoints() {
            return {
                kindness: 0,
                math_study: 0,
                chinese_study: 0,
                piano_practice: 0,
                helping: 0
            };
        }

        function isTodaySelected() {
            const today = new Date().toLocaleDateString("en-CA");
            return currentDate === today;
        }

        function updateDisplay() {
            categoriesDiv.innerHTML = "";
            let total = 0;

            defaultCategories.forEach(({ name, key }) => {
            const categoryDiv = document.createElement("div");
            categoryDiv.className = "category";

            const label = document.createElement("span");
            label.textContent = `${name}: ${points[key]} pts`;

            const btnAdd = document.createElement("button");
            btnAdd.disabled = !isTodaySelected();
            btnAdd.textContent = "+";
            btnAdd.className = "add";
            btnAdd.onclick = () => {
                if (!isTodaySelected()) return;
                points[key]++;
                logPointChange(key, 1);
                saveAndUpdate();
            };

            const btnSub = document.createElement("button");
            btnSub.textContent = "‚àí";
            btnSub.className = "subtract";
            btnSub.disabled = !isTodaySelected();
            btnSub.onclick = () => {
                if (!isTodaySelected()) return;
                if (points[key] > 0) {
                    points[key]--;
                    logPointChange(key, -1);
                    saveAndUpdate();
                }
            };

            const btns = document.createElement("div");
            btns.className = "buttons";
            btns.appendChild(btnAdd);
            btns.appendChild(btnSub);

            categoryDiv.appendChild(label);
            categoryDiv.appendChild(btns);
            categoriesDiv.appendChild(categoryDiv);

            total += points[key];
            });

            totalPointsSpan.textContent = total;
            drawChart();
        }

        function saveAndUpdate() {
            updateDisplay();
            db.ref(`progressLog/${currentDate}`).set({ points, log })
                .then(() => console.log("Synced to Firebase"))
                .catch(error => console.error("Sync failed:", error));
        }

        function logPointChange(category, delta) {
            const now = new Date();
            const local_ts = `${now.toLocaleDateString("en-CA")} ${now.toLocaleTimeString("en-US")}`
            log.push({
                category,
                delta,
                local_ts,
            });
        }

        const whiteBackgroundPlugin = {
            id: 'whiteBackgroundPlugin',
            beforeDraw(chart, args, options) {
                const ctx = chart.ctx;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = options.color || 'white';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        }

        function saveChartAndLog() {
            const today = new Date().toLocaleDateString('en-CA'); //yyyy-mm-dd
            const canvas = document.getElementById('progressChart');
            const imageLink = document.createElement('a');
            imageLink.href = canvas.toDataURL('image/png');
            imageLink.download = `sweet-points-chart-${today}.png`;
            imageLink.click();
        }


        function drawChart() {

            // Step 1: Extract and collect only the date part (YYYY-MM-DD)
            const datesSet = new Set();
            log.forEach(e => {
            const dateOnly = e.local_ts.split(" ")[0];  // Get just the date
            datesSet.add(dateOnly);
            });
            const dates = Array.from(datesSet).sort();

            // Step 2: Prepare categories & colors
            const categories = defaultCategories.map(c => c.key);
            const categoryNames = defaultCategories.map(c => c.name);
            const colors = defaultCategories.map(c => c.color);

            // Step 3: Initialize dataset map: category ‚Üí array of points per date
            const dataByCategory = {};
            categories.forEach(cat => {
                dataByCategory[cat] = dates.map(() => 0);
            });

            // Step 4: Aggregate points per date/category
            log.forEach(entry => {
                const dateOnly = entry.local_ts.split(" ")[0];
                const dateIndex = dates.indexOf(dateOnly);
                if (dateIndex >= 0) {
                dataByCategory[entry.category][dateIndex] += entry.delta;
                }
            });

            // Step 5: Build datasets for Chart.js
            const datasets = categories.map((cat, i) => ({
                label: categoryNames[i],
                data: dataByCategory[cat],
                backgroundColor: colors[i],
                borderRadius: 4,
                borderSkipped: false,
                maxBarThickness: 20,
            }));

            // Step 6: Create or update the chart
            const ctx = document.getElementById('progressChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, 
                {
                    type: 'bar',
                    data: {
                        labels: dates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    font: { size: 14 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} points`
                                }
                            },
                            whiteBackgroundPlugin: {}  // activate plugin here
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                min: 0,
                                max: 10,
                                ticks: {
                                    stepSize: 1
                                },
                                title: {
                                    display: true,
                                    text: 'Points',
                                    font: { size: 16, weight: 'bold' }
                                }
                            }
                        }
                    },
                    plugins: [whiteBackgroundPlugin],
                }
            );
        }

        function saveProgressToFirebase() {
            db.ref('progressLog').set(progressLog)
                .then(() => console.log("Progress saved to Firebase"))
                .catch(error => console.error("Save failed:", error));
        }

        function loadProgressFromFirebase(date, callback) {
            db.ref(`progressLog/${date}`).once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (data) callback(data);
                    else callback({ points: getEmptyPoints(), log: [] });
                })
                .catch(error => {
                    console.error("Load failed:", error);
                    callback({ points: getEmptyPoints(), log: [] });
                });
        }

        loadProgressFromFirebase(currentDate, (data) => {
            points = data.points || getEmptyPoints();
            log = data.log || [];
            updateDisplay();
        });


    </script>
</body>
</html>
